var News = require('./models/posts'),
    Menu = require('./models/menu'),
    Contact = require('./models/contact'),
    Users = require('./models/user'),
    Comments = require('./models/comment'),
    Answers = require('./models/answer'),
    Types = require('./models/type'),
    Cates = require('./models/category'),
    Media = require('./models/media'),
    Cmedia = require('./models/media_category'),
    multer = require('multer'),
    fs = require('fs'),
    youtubeThumbnail = require('youtube-thumbnail'),
    youtubeID = require('youtube-id');
var storage = multer.diskStorage({
    destination: function(req, file, cb) {
        cb(null, 'public/uploads')
    },
    filename: function(req, file, cb) {
        cb(null, Date.now() + path.extname(file.originalname));
    }
});
var upload = multer({
    storage: storage
});
module.exports = function(app) {
    var admin = app;
    // admin.use('/api/v1', function(req, res, next) {
    //     if (req.user) {
    //         if (req.user.auth == 1 || req.user.auth == 2) {
    //             return next();
    //         }
    //         return res.json({
    //             error: "You do not have the authority to perform this access!"
    //         });
    //     }
    //     return res.json({
    //         error: "You do not have the authority to perform this access!"
    //     });
    // });
    admin.get('/api/v1/news', function(req, res) {
        if (req.query.id) {
            News.findById(req.query.id, function(err, p) {
                res.json({
                    data: [p]
                });
            });
        } else {
            if (req.query.page) {
                var page = req.query.page;
            } else {
                var page = 1;
            }
            if (req.query.record) {
                var record = req.query.record;
            } else {
                var record = 10;
            }
            if (req.query.type) {
                var select = {
                    'type._id': req.query.type
                };
            } else {
                var select = {};
            }
            News.find(select).skip(page * record - record).limit(record).exec(function(err, p) {
                News.find(select).exec(function(err, total) {
                    res.json({
                        data: p,
                        current: parseInt(page),
                        total: Math.ceil(total.length / record)
                    });
                });
            });
        }
    });
    admin.get('/api/v1/users', function(req, res) {
        if (req.query.id) {
            Users.findById(req.query.id, function(err, p) {
                res.json({
                    data: [p]
                });
            });
        } else {
            if (req.query.page) {
                var page = req.query.page;
            } else {
                var page = 1;
            }
            if (req.query.record) {
                var record = req.query.record;
            } else {
                var record = 10;
            }
            if (req.query.type) {
                var select = {
                    auth: req.query.type
                };
            } else {
                var select = {};
            }
            Users.find(select).skip(page * record - record).limit(record).exec(function(err, p) {
                Users.find(select).exec(function(err, total) {
                    res.json({
                        data: p,
                        current: parseInt(page),
                        total: Math.ceil(total.length / record)
                    });
                });
            });
        }
    });
    admin.get('/api/v1/users/status/:id', function(req, res) {
        Users.findById(req.params.id, function(err, u) {
            u.status = !u.status;
            u.save(function(err, u) {
                res.json({
                    data: [u]
                });
            });
        });
    });
    admin.get('/api/v1/users/delete/:id', function(req, res) {
        Users.remove({
            _id: req.params.id
        }).exec(function(err, result) {
            res.json({
                data: [result]
            });
        });
    });
    admin.post('/api/v1/users/update/:id', function(req, res) {
        Users.findById(req.params.id, function(err, u) {
            u.firstname = req.body.firstname;
            u.lastname = req.body.lastname;
            u.province = req.body.province;
            u.phone = req.body.phone;
            u.gender = req.body.gender;
            u.birth = req.body.birth;
            u.desc = req.body.desc;
            u.save(function(err, u) {
                res.json({
                    data: [u]
                });
            });
        });
    });
    admin.post('/api/v1/users/auth/:id', function(req, res) {
        Users.findById(req.params.id, function(err, u) {
            u.auth = req.body.auth;
            u.save(function(err, u) {
                return res.json({
                    data: [u]
                });
            });
        });
    });
    admin.post('/api/v1/news/create', validatePost, function(req, res) {
        req.body.url = makeUrl(req.body.name);
        if (req.body.tags) {
            req.body.tags = req.body.tags.split(',');
        }
        req.body.user = {
            _id: req.user._id,
            fullname: req.user.firstname + " " + req.user.lastname,
            username: req.user.username,
            auth: req.user.auth,
            avatar: req.user.avatar
        };
        Types.findById(req.body.type, function(err, t) {
            req.body.type = {
                _id: t._id,
                name: t.name,
                url: t.url
            };
            Cates.findById(req.body.category, function(err, c) {
                if (req.body.category) {
                    req.body.category = {
                        _id: c._id,
                        name: c.name,
                        url: c.url
                    };
                }
                new News(req.body).save(function(err, p) {
                    res.json({
                        data: [p]
                    });
                });
            });
        });
    });
    
    admin.post('/api/v1/news/upload/:id', upload.single('file'), function(req, res) {
        News.findById(req.params.id, function(err, n) {
            n.img = '/uploads/' + req.file.filename;
            n.save(function(err, newN) {
                res.json({
                    data: [newN]
                });
            });
        })
    });
    admin.post('/api/v1/news/detail/:id', function(req, res) {
        News.findById(req.params.id, function(err, n) {
            var arr = n.content;
            arr.push({
                text: req.body.content
            });
            n.content = arr;
            n.save(function(err, newN) {
                res.json({
                    data: [newN]
                });
            });
        });
    });
    admin.post('/api/v1/news/detail/upload/:id', upload.single('file'), function(req, res) {
        News.findById(req.params.id, function(err, n) {
            var arr = n.content;
            arr[arr.length - 1].img = '/uploads/' + req.file.filename;
            n.content = arr;
            n.save(function(err, newN) {
                res.json({
                    data: [newN]
                });
            });
        });
    });
    admin.get('/api/v1/news/delete-detail/:id', function(req, res) {
        News.findById(req.params.id, function(err, n) {
            n.content = [];
            n.save(function(err, newN) {
                res.json({
                    data: [newN]
                });
            });
        });
    });
    /*comment*/
    admin.get('/api/v1/comments', function(req, res) {
        if (req.query.id) {
            Comments.find({
                pid: req.query.id
            }).sort({
                _id: -1
            }).exec(function(err, c) {
                var result = [];
                resComment(0, c, result, function(data) {
                    res.json({
                        data: data
                    });
                });
            });
        } else {
            Comments.find({}, function(err, c) {
                res.json({
                    data: [c]
                });
            });
        }
    });
    admin.get('/api/v1/comments/delete/:id', function(req, res) {
        Comments.remove({
            _id: req.params.id
        }, function(err, result) {
            res.json({
                data: [result]
            });
        });
    });
    admin.get('/api/v1/comments/accept/:id', function(req, res) {
        Comments.findById(req.params.id, function(err, c) {
            c.status = 1;
            c.save(function(err, newC) {
                res.json({
                    data: [newC]
                });
            });
        });
    });
    admin.get('/api/v1/answers/delete/:id', function(req, res) {
        Answers.remove({
            _id: req.params.id
        }, function(err, result) {
            res.json({
                data: [result]
            });
        });
    });
    admin.get('/api/v1/answers/accept/:id', function(req, res) {
        Answers.findById(req.params.id, function(err, a) {
            a.status = 1;
            a.save(function(err, newA) {
                res.json({
                    data: [newA]
                });
            });
        });
    });
    admin.post('/api/v1/comments/answer', function(req, res) {
        new Answers({
            cid: req.body.cid,
            user: {
                _id: req.user._id,
                username: req.user.username,
                fullname: req.user.fullname,
                auth: req.user.auth,
                avatar: req.user.avatar
            },
            content: req.body.content,
            status: 1
        }).save(function(err, newA) {
            res.json({
                data: [newA]
            });
        });
    });
    /*type*/
    admin.get('/api/v1/types', function(req, res) {
        if (req.query.id) {
            Types.findById(req.query.id, function(err, t) {
                res.json({
                    data: [t]
                });
            })
        } else {
            Types.find({}, function(err, t) {
                var result = [];
                resType(0, t, result, function(data) {
                    res.json({
                        data: data
                    });
                });
            })
        }
    });
    admin.post('/api/v1/types/create', function(req, res) {
        req.body.url = makeUrl(req.body.name);
        new Types(req.body).save(function(err, t) {
            res.json({
                data: [t]
            });
        });
    });
    admin.get('/api/v1/types/delete/:id', function(req, res) {
        Types.remove({
            _id: req.params.id
        }).exec();
        Cates.remove({
            'type._id': req.params.id
        }).exec();
        News.remove({
            'type._id': req.params.id
        }).exec();
        res.json({
            data: [{
                result: 'success'
            }]
        });
    });
    /**/
    /*cate*/
    admin.get('/api/v1/category', function(req, res) {
        if (req.query.id) {
            Cates.findById(req.query.id, function(err, t) {
                res.json({
                    data: [t]
                });
            })
        } else
        if (req.query.tid) {
            Cates.find({
                'type._id': req.query.tid
            }, function(err, t) {
                res.json({
                    data: t
                });
            })
        } else {
            Cates.find({}, function(err, t) {
                res.json({
                    data: t
                });
            })
        }
    });
    admin.post('/api/v1/category/create', function(req, res) {
        req.body.url = makeUrl(req.body.name);
        Types.findById(req.body.tid, function(err, t) {
            req.body.tid = null;
            req.body.type = {
                _id: t._id,
                name: t.name,
                url: t.url
            };
            new Cates(req.body).save(function(err, t) {
                res.json({
                    data: [t]
                });
            });
        });
    });
    admin.get('/api/v1/category/delete/:id', function(req, res) {
        Cates.remove({
            _id: req.params.id
        }).exec();
        News.remove({
            'category._id': req.params.id
        }).exec();
        res.json({
            data: [{
                result: 'success'
            }]
        });
    });
    /**/
    admin.get('/api/v1/menu', function(req, res) {
        Menu.find({}).sort({sort: 1}).exec(function(err, m) {
            res.json({
                data: m
            });
        });
    });
    admin.post('/api/v1/menu/create', function(req, res) {
        Menu.findOne({
            url: req.body.url
        }, function(err, m) {
            if (m) {
                Menu.remove({
                    url: req.body.url
                }).exec(function(err, result){
                    res.json({
                        data: [result]
                    });
                });
            } else {
                Menu.findOne().sort({$natural:-1}).exec(function(err, n){
                    if(n){
                        var sort = n.sort + 1;
                    }else{
                        var sort = 1;
                    }
                    req.body.sort = sort;
                    new Menu(req.body).save(function(err, m) {
                        res.json({
                            data: [m]
                        });
                    });
                });
            }
        });
    });
    admin.get('/api/v1/menu/sort/:id', function(req, res){
        Menu.findById(req.params.id, function(err, m){
            var index = m.sort - 1;
            setOldMenuIndex(index, function(n){
                var newIndex = n.sort;
                var oldIndex = m.sort;
                m.sort = newIndex;
                m.save();
                n.sort = oldIndex;
                n.save();
                res.json({
                    data: 'success'
                });
            });
        });
    });
    function setOldMenuIndex(index, callback){
        Menu.findOne({sort: index}, function(err, m){
            if(m){
                return callback(m);
            }else{
                index --;
                setOldMenuIndex(index, callback);
            }
        });
    }
    /**/
    admin.get('/api/v1/contact', function(req, res){
        Contact.find({}, function(err, c){
            res.json({data: c});
        });
    });
    admin.post('/api/v1/contact/update', function(req, res){
        Contact.update(req.body, function(err, c){    
            res.json({
                data: [c]
            });
        });
    });
    /**/
    admin.post('/api/v1/news/update', function(req, res) {
        News.update(req.body, function(err, n){
            res.json({
                data: [n]
            });
        });
    });
    admin.get('/api/v1/statist', function(req, res) {
        News.find({}, function(err, p){
            Types.find({}, function(err, t){
                Users.find(function(err, u){
                    res.json({
                        data: [{
                            tp: p.length,
                            tt: t.length,
                            tu: u.length,
                        }]
                    });
                });
            });
        });
    });
    admin.get('/api/v1/news/delete/:id', function(req, res) {
        News.findById(req.params.id, function(err, p) {
            News.remove({
                _id: req.params.id
            }, function(err, result) {
                fs.unlinkSync('public' + p.img);
                res.json({
                    data: [result]
                });
            });
        });
    });
    /*media*/
    admin.get('/api/v1/media', function(req, res) {
        if (req.query.id) {
            Media.findById(req.query.id, function(err, p) {
                res.json({
                    data: [p]
                });
            });
        } else {
            if (req.query.page) {
                var page = req.query.page;
            } else {
                var page = 1;
            }
            if (req.query.record) {
                var record = req.query.record;
            } else {
                var record = 10;
            }
            if(req.query.media){
                var media = req.query.media
            }
            if (req.query.type) {
                var select = {
                    'type._id': req.query.type,
                    media: media
                };
            } else {
                var select = {
                    media: media
                };
            }
            Media.find(select).skip(page * record - record).limit(record).exec(function(err, p) {
                Media.find(select).exec(function(err, total) {
                    res.json({
                        data: p,
                        current: parseInt(page),
                        total: Math.ceil(total.length / record)
                    });
                });
            });
        }
    });
    admin.post('/api/v1/media/category/create', function(req, res){
        Cmedia.findOne({name: req.body.name}, function  (err, c) {
            if(c){
                return res.json({error: "Tên danh mục media đã tồn tại!"});
            }
            req.body.url = makeUrl(req.body.name);
            req.type = 'video';
            new Cmedia(req.body).save(function(err, c){
                res.json({
                    data: [c]
                });
            });
        });
    });
    admin.post('/api/v1/media/create', validatePost, function(req, res) {
        req.body.url = makeUrl(req.body.name);
        if (req.body.tags) {
            req.body.tags = req.body.tags.split(',');
        }
        req.body.user = {
            _id: req.user._id,
            fullname: req.user.firstname + " " + req.user.lastname,
            username: req.user.username,
            auth: req.user.auth,
            avatar: req.user.avatar
        };
        if(req.body.first_frame){
            req.body.img = youtubeThumbnail(req.body.src.toString()).medium.url;
        }
        if(req.body.media == 'video'){
            req.body.video = {
                src: req.body.src,
                id: youtubeID(req.body.src)
            }
        }
        if(req.body.media == 'image'){
            
        }
        Cmedia.findById(req.body.type, function(err, t) {
            req.body.type = {
                _id: t._id,
                name: t.name,
                url: t.url
            };
            new Media(req.body).save(function(err, p) {
                res.json({
                    data: [p]
                });
            });
        });
    });
    admin.post('/api/v1/media/upload/:id', upload.single('file'), function(req, res) {
        Videos.findById(req.params.id, function(err, n) {
            n.img = '/uploads/' + req.file.filename;
            n.save(function(err, newN) {
                res.json({
                    data: [newN]
                });
            });
        })
    });
    admin.post('/api/v1/upload', upload.single('upload'), function(req, res){
        console.log(req.file);
    });
    admin.get('/api/v1/media/category/delete/:id', function(req, res){
        Cmedia.remove({_id: req.params.id}).exec(function(err, result){
            res.json({
                data: [result]
            });
        });
    });
    admin.get('/api/v1/media/category', function(req, res){
        var selector = {
            type: req.query.media
        }
        Cmedia.find(selector, function(err, c){
            res.json({data: c});
        });
    });
    function makeUrl(str) {
        var str = str.toString().trim().toLowerCase();
        return str.replace(/á|ạ|ả|ã|à|ă|ắ|ẳ|ặ|â|ấ|ậ|ẫ/g, 'a').replace(/é|ẹ|ẻ|è|ê|ế|ệ|ề|ể/g, 'e').replace(/ó|ọ|ỏ|ò|õ|ô|ố|ộ|ổ|ồ|ỗ|ố|ơ|ớ|ở|ờ|ợ/g, 'o').replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g, 'u').replace(/ì|í|ị|ỉ|ĩ/g, 'i').replace(/ỳ|ý|ỵ|ỷ|ỹ/g, 'y').replace(/đ/g, 'd').replace(/:|( -)|'|"|,|;|<|>|\+|\(|\)/g, '').replace(/\n|\r| /g, '-');
    }
    function validatePost(req, res, next){
        var url = makeUrl(req.body.name);
        if(url == "lien-he" || url == "media" || url == 'thong-bao' || url == 'dang-ky' || url == 'dang-nhap'){
            return res.json({
                error: "Tên tin tức không hợp lệ!"
            });
        }
        Types.findOne({url: url}, function (err, t) {
            if(!t){
                Cates.findOne({url: url}, function (err, c) {
                    if(!c){
                        return next();
                    }else{
                        res.json({
                            error: "Tên tin tức không hợp lệ!"
                        });
                    }
                });
            }else{
                res.json({
                    error: "Tên tin tức không hợp lệ!"
                });
            }
        });
    }
    var result = [];

    function resComment(i, arr, result, callback) {
        if (arr.length == 0) {
            return callback(null);
        }
        if (i < arr.length) {
            Answers.find({
                cid: arr[i]._id
            }).exec(function(err, a) {
                result.push({
                    comment: arr[i],
                    answers: a
                });
                i++;
                resComment(i, arr, result, callback);
            });
        }
        if (i == arr.length) {
            return callback(result);
        }
    }

    function resType(i, arr, result, callback) {
        if (arr.length == 0) {
            return callback(null);
        }
        if (i < arr.length) {
            Cates.find({
                'type._id': arr[i]._id
            }).exec(function(err, a) {
                result.push({
                    type: arr[i],
                    cates: a
                });
                i++;
                resType(i, arr, result, callback);
            });
        }
        if (i == arr.length) {
            return callback(result);
        }
    }
}